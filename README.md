# pjud-webscrapping
Necesitamos implementar un proceso RPA que realice los siguientes pasos:

## Paso - Ingresar al CRM y buscar un cliente: [URL]()
## Paso - Ingresar al PJUD: [URL](https://oficinajudicialvirtual.pjud.cl/home/index.php)
## Paso - Ingresar en consulta de causas: [URL](https://oficinajudicialvirtual.pjud.cl/indexN.php)
![alt text](<assets/img/Imagen de WhatsApp 2025-10-20 a las 16.04.07_eed0e425.jpg>)

Ejemplos
| Competencia  | Corte            | Tribunal                        | Libro/Tipo  | Rol  | AÃ±o  |
|--------------|------------------|---------------------------------|-------------|------|------|
| Civil        | C.A. de Santiago | 18Â° Juzgado Civil de Santiago   | C           | 7606 | 2022 | 
| Civil        | C.A. de Santiago | 18Â° Juzgado Civil de Santiago   | C           | 0000 | 0000 | folio: 24734 case_id: 34748
| Civil        | C.A. de Santiago | 18Â° Juzgado Civil de Santiago   | C           | 0000 | 0000 | folio: 24734 case_id: 37933

## Paso - BÃºsqueda de ese cliente por RIT
![alt text](<assets/img/Imagen de WhatsApp 2025-10-20 a las 16.05.41_1d314e6b.jpg>)

## Paso - Detectar cambios en el PJUD
[PJUD](https://www.pjud.cl/)
[OJV](https://oficinajudicialvirtual.pjud.cl/home/)

## Paso - Descargar EBOOK
![alt text](<assets/img/Imagen de WhatsApp 2025-10-20 a las 16.07.06_bbea00f3.jpg>)

## Paso - Insertar datos en CRM
Este paso lo realizarÃ¡n Hans/Jhon

## Paso - NotificaciÃ³n por EMAIL


ðŸ“ Estructura recomendada del proyecto
```pgsql 
src/
  automation/
    pjud/
      index.js âœ… 6. index.js â€” Archivo principal
      browser.js âœ… 1. browser.js â€” Manejo del navegador
      navigation.js âœ… 3. navigation.js â€” Toda la navegaciÃ³n del PJUD
      extract.js âœ… 4. extract.js â€” ExtracciÃ³n de tabla de movimientos
      ebook.js âœ… 5. ebook.js â€” Descarga del PDF eBook
      utils.js âœ… 2. utils.js â€” Paths, logs y carga de JSON
  config/
    pjud_config.json
  assets/
    ebook/
logs/
.env
```

# TODO
âœ… logging avanzado
âœ… retry automÃ¡tico si falla el PJUD
âœ… exportar los datos a JSON/CSV
âœ… procesar mÃºltiples RIT desde una lista

+---------------+--------------------------------------------------+-----------+----------------+---------------------+---------------------+---------------+---------+----------------------+----------------------+--------------------+    
| Db            | Name                                             | Type      | Definer        | Modified            | Created             | Security_type | Comment | character_set_client | collation_connection | Database Collation |    
+---------------+--------------------------------------------------+-----------+----------------+---------------------+---------------------+---------------+---------+----------------------+----------------------+--------------------+    
| codi_ejamtest | fsp_Contratos_Sel                                | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |    
| codi_ejamtest | fsp_Cuotas_a_Vencer_Sel                          | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |    
| codi_ejamtest | fsp_Estado_de_Cuenta_Sel                         | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |    
| codi_ejamtest | fsp_Last_Envios_Sel                              | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |    
| codi_ejamtest | fsp_l_Buscar_Contratos_Cliente_Sel               | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
| codi_ejamtest | fsp_l_Buscar_Contrato_Cuotas_Impagas_Sel         | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
| codi_ejamtest | fsp_l_Buscar_Rut_Sel                             | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
| codi_ejamtest | fsp_l_gateway_aplicar_pago                       | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
| codi_ejamtest | fsp_l_gateway_aplicar_pago_todos                 | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
| codi_ejamtest | fsp_l_gateway_genera_pago_ext_Up                 | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
| codi_ejamtest | fsp_l_gateway_pagos_solicitados_header_Estado_Up | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
| codi_ejamtest | fsp_l_gateway_pagos_solicitados_header_Sel       | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
| codi_ejamtest | fsp_Mails_Enviados_Ins_Upd                       | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
| codi_ejamtest | fsp_Pagos_Recibidos_Sel                          | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
| codi_ejamtest | fsp_Testigo_Enviados                             | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
| codi_ejamtest | lsp_gateway_pagos_solicitados_detail_Ins         | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
| codi_ejamtest | lsp_gateway_pagos_solicitados_Header_Ins         | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
| codi_ejamtest | lsp_gateway_pagos_solicitados_Ins                | PROCEDURE | root@localhost | 2025-12-08 23:22:38 | 2025-12-08 23:22:38 | DEFINER       |         | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
+---------------+--------------------------------------------------+-----------+----------------+---------------------+---------------------+---------------+---------+----------------------+----------------------+--------------------+

SHOW PROCEDURE STATUS WHERE Db = 'codi_ejamtest';

# SHOW CREATE PROCEDURE codi_ejamtest.fsp_Contratos_Sel;
+-------------------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure         | sql_mode              | Create Procedure                                                                                                                                          | character_set_client | collation_connection | Database Collation |
+-------------------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| fsp_Contratos_Sel | NO_AUTO_VALUE_ON_ZERO | CREATE DEFINER=`root`@`localhost` PROCEDURE `fsp_Contratos_Sel`()
BEGIN
select
min(id) as contrato_id_Min,
max(id) as contrato_id_Max
from contrato;
END | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
+-------------------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.000 sec)

# SHOW CREATE PROCEDURE codi_ejamtest.fsp_Estado_de_Cuenta_Sel;
+--------------------------+-----------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure                | sql_mode              | Create Procedure                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | character_set_client | collation_connection | Database Collation |
+--------------------------+-----------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| fsp_Estado_de_Cuenta_Sel | NO_AUTO_VALUE_ON_ZERO | CREATE DEFINER=`root`@`localhost` PROCEDURE `fsp_Estado_de_Cuenta_Sel`(IN `contrato_id` INT, IN `fecha` DATE)
BEGIN
select 
contrato.id as contrato_id,
cuota.id as cuota_id,
contrato.nombre,
contrato.email,
cuota.numero,
cuota.fecha_pago as Vence,
cuota.monto,
case 
when ISNULL(cuota.pagado)=1 then 0 
else cuota.pagado
end 
as pagado,
f_html_cliente(2,contrato.nombre,-999,cuota.fecha_pago) as template
from cuota,contrato
where cuota.contrato_id=contrato.id
and contrato.id=contrato_id
and contrato.id not in
(select contrato_id from mails_enviados where mails_enviados.contrato_id=contrato_id and cast(fecha_enviado as date)=fecha and tipo_envio_id=2)
order by cuota.numero;
END | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
+--------------------------+-----------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.017 sec)

# SHOW CREATE PROCEDURE codi_ejamtest.fsp_Last_Envios_Sel;
+---------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure           | sql_mode              | Create Procedure                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | character_set_client | collation_connection | Database Collation |
+---------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| fsp_Last_Envios_Sel | NO_AUTO_VALUE_ON_ZERO | CREATE DEFINER=`root`@`localhost` PROCEDURE `fsp_Last_Envios_Sel`(
)
BEGIN
DECLARE v_envio_1 int;
DECLARE v_envio_2 int;
DECLARE v_envio_3 int;
SET v_envio_1 = (select max(id) from mails_enviados where tipo_envio_id=1);
SET v_envio_2 = (select max(id) from mails_enviados where tipo_envio_id=2);
SET v_envio_3 = (select max(id) from mails_enviados where tipo_envio_id=3);
select

        IFNULL(v_envio_1,0) AS anvio1,
    IFNULL(v_envio_2,0) AS anvio2,
    IFNULL(v_envio_3,0) AS anvio3;
END | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
+---------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.003 sec)

# SHOW CREATE PROCEDURE codi_ejamtest.fsp_l_Buscar_Contratos_Cliente_Sel;
+------------------------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure                          | sql_mode              | Create Procedure                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | character_set_client | collation_connection | Database Collation |
+------------------------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| fsp_l_Buscar_Contratos_Cliente_Sel | NO_AUTO_VALUE_ON_ZERO | CREATE DEFINER=`root`@`localhost` PROCEDURE `fsp_l_Buscar_Contratos_Cliente_Sel`(IN `p_rut` VARCHAR(255))
    NO SQL
BEGIN

CREATE TEMPORARY TABLE temp_DEUDA AS

select

UPPER('Civil') AS tipo_contrato,
contrato.rut as rut ,
contrato.id as contrato_id,
contrato.nombre,

min(cuota.fecha_pago) as Vto,
sum(cuota.monto-
                        case
                                when ISNULL(cuota.pagado)=1 then 0
                else cuota.pagado
            end )
            as deuda,
sum(
                        case
                                when DATE(cuota.fecha_pago)>CURDATE() then
                                        case
                                                when ISNULL(cuota.pagado)=1 then cuota.monto-0
                                                else cuota.monto-cuota.pagado
                                        end

                else 0
            end )
            as aldia,

            sum(
                        case
                                when DATE(cuota.fecha_pago)<=CURDATE() then
                                        case
                                                when ISNULL(cuota.pagado)=1 then cuota.monto-0 
                                                else cuota.monto-cuota.pagado
                                        end

                else 0
            end )
            as vencida

 from cuota,contrato

 where contrato.rut=p_rut
 and cuota.contrato_id=contrato.id


 and cuota.monto-
                        case
                                when ISNULL(cuota.pagado)=1 then 0
                else cuota.pagado
            end >0

group by tipo_contrato,contrato.rut,contrato.id,contrato.nombre;


select

*,
case
        when vencida=0 then 'FECHA VENCIMIENTO'
    else 'ESTAS ATRASADO DESDE EL'
end as leyenda_vto,
case 
        when vencida=0 then aldia
    else vencida
    end as primer_monto

 from temp_DEUDA

 order by contrato_id;


DROP TEMPORARY TABLE temp_DEUDA;



END | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
+------------------------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.005 sec)

# SHOW CREATE PROCEDURE codi_ejamtest.fsp_l_Buscar_Contrato_Cuotas_Impagas_Sel;
+------------------------------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure                                | sql_mode              | Create Procedure                                                                                                                                                                           
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                               | character_set_client | collation_connection | Database Collation |
+------------------------------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| fsp_l_Buscar_Contrato_Cuotas_Impagas_Sel | NO_AUTO_VALUE_ON_ZERO | CREATE DEFINER=`root`@`localhost` PROCEDURE `fsp_l_Buscar_Contrato_Cuotas_Impagas_Sel`(IN `p_contrato_id` INT)
    NO SQL
BEGIN

select


contrato.id as contrato_id,
contrato.nombre,

DATE_FORMAT(fecha_pago, '%Y/%m/%d') as Vto,
cuota.monto-
                        case
                                when ISNULL(cuota.pagado)=1 then 0
                else cuota.pagado
            end
            as monto

 from cuota,contrato

 where cuota.contrato_id=contrato.id
 and cuota.contrato_id=p_contrato_id 


 and cuota.monto-
                        case
                                when ISNULL(cuota.pagado)=1 then 0
                else cuota.pagado
            end >0

order by cuota.contrato_id,cuota.fecha_pago;


END | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
+------------------------------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.000 sec)

# SHOW CREATE PROCEDURE codi_ejamtest.fsp_l_Buscar_Rut_Sel;
+----------------------+-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure            | sql_mode              | Create Procedure                                                                                                                                                                                               
                                    | character_set_client | collation_connection | Database Collation |
+----------------------+-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| fsp_l_Buscar_Rut_Sel | NO_AUTO_VALUE_ON_ZERO | CREATE DEFINER=`root`@`localhost` PROCEDURE `fsp_l_Buscar_Rut_Sel`(IN `p_rut` VARCHAR(255))
    NO SQL
BEGIN
select
        contrato.id as contrato_id,
        contrato - nombre,
        contrato.rut as rut 
from
        contrato
where
        contrato.rut = p_rut;
END | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
+----------------------+-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+

# SHOW CREATE PROCEDURE codi_ejamtest.fsp_l_gateway_aplicar_pago;
+----------------------------+-----------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure                  | sql_mode              | Create Procedure                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
                                                        | character_set_client | collation_connection | Database Collation |
+----------------------------+-----------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| fsp_l_gateway_aplicar_pago | NO_AUTO_VALUE_ON_ZERO | CREATE DEFINER=`root`@`localhost` PROCEDURE `fsp_l_gateway_aplicar_pago`(IN `p_id_pago` INT, IN `p_contrato_id` INT, IN `p_pago` INT)
BEGIN




DECLARE done INT DEFAULT 0;


DECLARE v_generadorid int;
DECLARE v_Saldo int DEFAULT p_pago;
DECLARE v_Deuda int;

DECLARE v_imputado int;

DECLARE v_ncomprobante varchar(255);
DECLARE v_comprobante varchar(255);



DECLARE Cursor9 CURSOR FOR  select id,


                (monto -
                                        case
                                                when ISNULL(cuota.pagado)=1 then 0
                        else cuota.pagado
                                         end ) AS Deuda
        FROM cuota
        WHERE contrato_id=p_contrato_id
        and (monto -
                                        case
                                                when ISNULL(cuota.pagado)=1 then 0
                        else cuota.pagado
                                         end ) >0


        ORDER BY fecha_pago;


 DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

 Open Cursor9 ;
        label: LOOP


        FETCH Cursor9 INTO v_generadorid,v_Deuda;

        IF v_Saldo IS NULL OR v_Saldo <= 0 THEN
            LEAVE label;
        END IF;


        IF v_Saldo >= v_Deuda THEN


                        set v_imputado=v_Deuda;

            update cuota

            set pagado=
                                        case
                                                when ISNULL(cuota.pagado)=1 then v_Deuda 
                        else cuota.pagado+v_Deuda
                                         end

            WHERE id = v_generadorid;

            SET v_Saldo = v_Saldo - v_Deuda;



            update contrato

                        set proximo_vencimiento=

                                                (select fecha_pago from cuota where contrato_id=p_contrato_id and numero=( select numero+1 from cuota where id=v_generadorid))

                                where id=p_contrato_id;


                ELSE
        


            set v_imputado=v_Saldo;

            update cuota

            set pagado=
                                        case
                                                when ISNULL(cuota.pagado)=1 then v_Saldo
                        else cuota.pagado+v_Saldo
                                         end

            WHERE id = v_generadorid;

            SET v_Saldo = 0;



        END IF;



        select ext_ref_pago into v_ncomprobante from gateway_pagos_solicitados_header where id=p_id_pago;



        INSERT INTO pago
                                (
                                pago_tipo_id,
                                pago_canal_id,
                                usuario_registro_id,
                                monto,
                                boleta,
                                observacion,
                                fecha_pago,
                                hora_pago,
                                fecha_registro,
                                cuenta_corriente_id,
                                fecha_ingreso,
                                ncomprobante,
                                comprobante,
                                usuario_anulacion_id,
                                anulado,
                                fecha_anulacion,
                contrato_id)
                                VALUES

                                (

                                 4,
                                 5,
                                 1,
                                 v_imputado,
                                 null,
                                 'Recepcionado por pago en linea',
                                 NOW(),
                                 CURTIME(),
                                 NOW(),
                                 4,
                                 NOW(),
                                 v_ncomprobante,
                                 'nodisponible.png',
                                 null,
                                 null,
                                 null,
                                p_contrato_id
                                );




                INSERT INTO pago_cuotas
                                (
                                        pago_id, 
                    cuota_id,
                    monto
                                )

                values

                (

                                        LAST_INSERT_ID(),
                    v_generadorid,
                    v_imputado


                );





    FETCH Cursor9 INTO v_generadorid,v_Deuda;




 IF done = 1 THEN
        LEAVE label;
  END IF;

      END LOOP;
      CLOSE Cursor9;







END | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
+----------------------------+-----------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.005 sec)

# SHOW CREATE PROCEDURE codi_ejamtest.fsp_l_gateway_aplicar_pago_todos;
+----------------------------------+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure                        | sql_mode              | Create Procedure                                                                                                                                                                                   
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
                                                              | character_set_client | collation_connection | Database Collation |
+----------------------------------+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| fsp_l_gateway_aplicar_pago_todos | NO_AUTO_VALUE_ON_ZERO | CREATE DEFINER=`root`@`localhost` PROCEDURE `fsp_l_gateway_aplicar_pago_todos`(IN p_id_pago INT)
BEGIN
    DECLARE v_contrato_id INT;
    DECLARE v_pago DECIMAL(10,2);
    DECLARE v_apagar DECIMAL(10,2);
    DECLARE v_id_cuota INT;
    DECLARE done_cuotas INT DEFAULT 0;


    DECLARE cur_cuotas CURSOR FOR SELECT id, apagar FROM Estas_Cuotas;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done_cuotas = 1;


    SELECT contrato_id, monto_solicitud
    INTO v_contrato_id, v_pago
    FROM gateway_pagos_solicitados_detail
    WHERE id = p_id_pago;

    CREATE TEMPORARY TABLE IF NOT EXISTS Estas_Cuotas AS
        SELECT id, (monto - IFNULL(pagado, 0)) AS apagar
        FROM (
            SELECT *,
                   (@running_total := @running_total + (monto - IFNULL(pagado, 0))) AS cumulative_unpaid
            FROM cuota, (SELECT @running_total := 0) AS vars
            WHERE contrato_id = v_contrato_id
              AND (monto - IFNULL(pagado, 0)) > 0
            ORDER BY fecha_pago ASC
        ) AS cuotas_con_acumulado
        WHERE cumulative_unpaid - (monto - IFNULL(pagado, 0)) < v_pago;

    OPEN cur_cuotas;

    read_cuotas: LOOP
        FETCH cur_cuotas INTO v_id_cuota, v_apagar;
        IF done_cuotas THEN
            LEAVE read_cuotas;
        END IF;


        CALL fsp_l_gateway_aplicar_pago(p_id_pago, v_contrato_id, v_apagar);

    END LOOP;

    CLOSE cur_cuotas;
    DROP TEMPORARY TABLE IF EXISTS Estas_Cuotas;
END | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
+----------------------------------+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.002 sec)

# SHOW CREATE PROCEDURE codi_ejamtest.fsp_l_gateway_genera_pago_ext_Up;
+----------------------------------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure                        | sql_mode              | Create Procedure                                                                                                                                                                                   
                                                                                                             | character_set_client | collation_connection | Database Collation |
+----------------------------------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| fsp_l_gateway_genera_pago_ext_Up | NO_AUTO_VALUE_ON_ZERO | CREATE DEFINER=`root`@`localhost` PROCEDURE `fsp_l_gateway_genera_pago_ext_Up`(p_id int,p_gateway_id int,p_id_estado int,p_ext_ref_pago varchar(100))
BEGIN



UPDATE gateway_pagos_solicitados_header

set
gateway_id=p_gateway_id,
id_estado=p_id_estado,
ext_ref_pago=p_ext_ref_pago

WHERE id=p_id;


END | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
+----------------------------------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.000 sec)

# SHOW CREATE PROCEDURE codi_ejamtest.fsp_l_gateway_pagos_solicitados_header_Estado_Up;
+--------------------------------------------------+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure                                        | sql_mode              | Create Procedure                                                                                                                                                                   
                                                                                                                                            | character_set_client | collation_connection | Database Collation |
+--------------------------------------------------+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| fsp_l_gateway_pagos_solicitados_header_Estado_Up | NO_AUTO_VALUE_ON_ZERO | CREATE DEFINER=`root`@`localhost` PROCEDURE `fsp_l_gateway_pagos_solicitados_header_Estado_Up`(IN `p_id` INT, IN `p_id_estado` INT)
    NO SQL
BEGIN




UPDATE gateway_pagos_solicitados_header

set id_estado=p_id_estado

WHERE id=p_id

and case
                when p_id_estado=2 then 1
        else
        id_estado
        end ;

END | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
+--------------------------------------------------+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.002 sec)

# SHOW CREATE PROCEDURE codi_ejamtest.fsp_l_gateway_pagos_solicitados_header_Sel;
+--------------------------------------------+-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure                                  | sql_mode              | Create Procedure                                                                                                                                                                         
                                                                                                                                                                                                                                                                
                                                                  | character_set_client | collation_connection | Database Collation |
+--------------------------------------------+-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| fsp_l_gateway_pagos_solicitados_header_Sel | NO_AUTO_VALUE_ON_ZERO | CREATE DEFINER=`root`@`localhost` PROCEDURE `fsp_l_gateway_pagos_solicitados_header_Sel`(IN `p_id_pago` INT)
    NO SQL
BEGIN


select
gateway_pagos_solicitados_header.rut,
(select email from contrato where contrato.rut =gateway_pagos_solicitados_header.rut limit 1) as email,
gateway_pagos_solicitados_header.monto_total_solicitud

from gateway_pagos_solicitados_header


where gateway_pagos_solicitados_header.id=p_id_pago;




call fsp_l_gateway_pagos_solicitados_header_Estado_Up(p_id_pago,2);



END | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
+--------------------------------------------+-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.000 sec)

# SHOW CREATE PROCEDURE codi_ejamtest.fsp_Mails_Enviados_Ins_Upd;
+----------------------------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure                  | sql_mode              | Create Procedure                                                                                                                                                                                         
                                                                                                                                                                                                                                                 | character_set_client | collation_connection | Database Collation |
+----------------------------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| fsp_Mails_Enviados_Ins_Upd | NO_AUTO_VALUE_ON_ZERO | CREATE DEFINER=`root`@`localhost` PROCEDURE `fsp_Mails_Enviados_Ins_Upd`(IN `tipo_envio_id` INT, IN `fecha_enviado` DATETIME, IN `contrato_id` INT, IN `pago_cuota_id` INT, IN `pago_id` INT, IN `cuota_id` INT, IN `estado` INT)
BEGIN

insert INTo mails_enviados(tipo_envio_id, fecha_enviado, contrato_id, pago_cuota_id, pago_id, cuota_id, estado)
values(tipo_envio_id, fecha_enviado, contrato_id, pago_cuota_id, pago_id, cuota_id, estado);
END | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
+----------------------------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+

# SHOW CREATE PROCEDURE codi_ejamtest.fsp_Pagos_Recibidos_Sel;
+-------------------------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure               | sql_mode              | Create Procedure                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                            | character_set_client | collation_connection | Database Collation |
+-------------------------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| fsp_Pagos_Recibidos_Sel | NO_AUTO_VALUE_ON_ZERO | CREATE DEFINER=`root`@`localhost` PROCEDURE `fsp_Pagos_Recibidos_Sel`(IN `fecha` DATE)
BEGIN
select
pago.contrato_id,
pago.id as pago_id,
-999 as cuota_id,
-999  as pago_cuotas_id,
contrato.nombre,
contrato.email,
pago.fecha_pago,
pago.hora_pago,
pago.fecha_registro,
pago.fecha_ingreso,
pago.monto,
pago.comprobante ,
f_html_cliente(1,contrato.nombre,pago.monto,pago.fecha_pago,pago.hora_pago,pago.fecha_registro) as template
from pago,contrato
where  pago.contrato_id=contrato.id
and cast(pago.fecha_registro as date)<=cast(fecha as date)
and pago.anulado IS NULL
and pago.id not in 
(select pago_id from mails_enviados where estado=1)
and cast(pago.fecha_registro as date)>'2024-08-15'
order by pago.id;
END | utf8mb4              | utf8mb4_general_ci   | latin1_swedish_ci  |
+-------------------------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.000 sec)

# SHOW CREATE PROCEDURE codi_ejamtest.fsp_Testigo_Enviados;

# SHOW CREATE PROCEDURE codi_ejamtest.lsp_gateway_pagos_solicitados_detail_Ins;

# SHOW CREATE PROCEDURE codi_ejamtest.lsp_gateway_pagos_solicitados_Header_Ins;

# SHOW CREATE PROCEDURE codi_ejamtest.lsp_gateway_pagos_solicitados_Ins;