<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Causas - Sistema Legal</title>
    <!-- Bootstrap 4 (mismo que usa PJUD) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <!-- Font Awesome (iconos similares a PJUD) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           COLORIMETR√çA INSTITUCIONAL
           Azul Marino, Rojo, Blanco y Crema Oto√±al
           ============================================ */
        :root {
            /* Colores principales institucionales */
            --primary: #1a237e;          /* Azul marino oscuro */
            --primary-dark: #0d47a1;     /* Azul marino muy oscuro */
            --primary-light: #1565c0;    /* Azul marino claro */
            --primary-accent: #1976d2;   /* Azul marino medio */
            
            --secondary: #c62828;        /* Rojo institucional */
            --secondary-dark: #b71c1c;   /* Rojo oscuro */
            --secondary-light: #d32f2f;  /* Rojo claro */
            
            /* Colores crema oto√±al */
            --cream-light: #f5e6d3;      /* Crema muy claro */
            --cream: #e8d5b7;            /* Crema medio */
            --cream-dark: #d4a574;       /* Crema oscuro */
            --cream-accent: #c9a961;     /* Crema acento */
            
            /* Estados */
            --success: #2e7d32;          /* Verde oscuro */
            --warning: #f57c00;          /* Naranja */
            --danger: #c62828;           /* Rojo (igual que secondary) */
            --info: #1565c0;              /* Azul marino claro */
            
            /* Fondos */
            --bg-page: #faf8f5;          /* Crema muy claro (fondo p√°gina) */
            --bg-card: #ffffff;          /* Blanco puro */
            --bg-header: linear-gradient(135deg, #1a237e 0%, #0d47a1 50%, #1565c0 100%);
            --bg-sidebar: #1a237e;       /* Azul marino */
            --bg-cream: #f5e6d3;         /* Crema claro para fondos */
            --bg-cream-light: #faf8f5;   /* Crema muy claro */
            
            /* Textos */
            --text-primary: #1a1a1a;     /* Negro suave */
            --text-secondary: #424242;    /* Gris oscuro */
            --text-muted: #757575;       /* Gris medio */
            --text-light: #ffffff;       /* Blanco */
            --text-on-cream: #5d4037;    /* Marr√≥n para texto sobre crema */
            
            /* Bordes */
            --border-color: #e0e0e0;     /* Gris claro */
            --border-light: #f5f5f5;     /* Gris muy claro */
            --border-cream: #e8d5b7;     /* Crema para bordes */
            
            /* Sombras */
            --shadow-sm: 0 1px 2px 0 rgba(26, 35, 126, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(26, 35, 126, 0.15);
            --shadow-lg: 0 10px 15px -3px rgba(26, 35, 126, 0.2);
            --shadow-xl: 0 20px 25px -5px rgba(26, 35, 126, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-page);
            background-image: linear-gradient(to bottom, var(--cream-light) 0%, var(--bg-page) 100%);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ============================================
           HEADER - Estilo Institucional
           ============================================ */
        .pjud-header {
            background: var(--bg-header);
            color: white;
            padding: 0;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--secondary);
        }

        .header-top {
            background: rgba(198, 40, 40, 0.2);  /* Rojo transl√∫cido */
            padding: 8px 0;
            font-size: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header-top .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-main {
            padding: 15px 0;
        }

        .header-main .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .logo-text h1 {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 400;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* ============================================
           NAVEGACI√ìN - Tabs estilo PJUD
           ============================================ */
        .nav-tabs-pjud {
            background: rgba(0,0,0,0.1);
            padding: 0 20px;
        }

        .nav-tabs-pjud .nav-link {
            color: rgba(255,255,255,0.8);
            border: none;
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 0;
            transition: all 0.2s;
        }

        .nav-tabs-pjud .nav-link:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }

        .nav-tabs-pjud .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.2);
            border-bottom: 3px solid white;
        }

        .nav-tabs-pjud .nav-link i {
            margin-right: 8px;
        }

        /* ============================================
           CONTENEDOR PRINCIPAL
           ============================================ */
        .main-container {
            padding: 25px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ============================================
           BREADCRUMB - Estilo PJUD
           ============================================ */
        .pjud-breadcrumb {
            background: var(--cream-light);
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            border-left: 4px solid var(--primary);
        }

        .pjud-breadcrumb a {
            color: var(--primary);
            text-decoration: none;
        }

        .pjud-breadcrumb a:hover {
            text-decoration: underline;
        }

        .pjud-breadcrumb span {
            color: var(--text-muted);
        }

        /* ============================================
           FORMULARIO DE B√öSQUEDA - Estilo Institucional
           ============================================ */
        .search-card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            margin-bottom: 25px;
            border: 1px solid var(--border-cream);
        }

        .search-card-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--secondary);
        }

        .search-card-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-card-body {
            padding: 25px;
        }

        .form-row-pjud {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group-pjud {
            display: flex;
            flex-direction: column;
        }

        .form-group-pjud label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .form-group-pjud label .required {
            color: var(--danger);
        }

        .form-control-pjud {
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }

        .form-control-pjud:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-control-pjud:disabled {
            background: var(--bg-page);
            cursor: not-allowed;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .btn-pjud {
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
        }

        .btn-pjud-primary {
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary-dark);
        }

        .btn-pjud-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-pjud-secondary {
            background: var(--bg-page);
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
        }

        .btn-pjud-secondary:hover {
            background: var(--border-color);
        }

        /* ============================================
           TABLA DE RESULTADOS - Estilo Institucional
           ============================================ */
        .results-card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            margin-bottom: 25px;
            border: 1px solid var(--border-cream);
        }

        .results-card-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--secondary);
        }

        .results-card-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .results-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .table-pjud {
            width: 100%;
            border-collapse: collapse;
        }

        .table-pjud thead {
            background: var(--bg-page);
        }

        .table-pjud th {
            padding: 12px 15px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
        }

        .table-pjud td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-light);
            font-size: 13px;
            vertical-align: middle;
        }

        .table-pjud tbody tr {
            transition: background 0.15s;
        }

        .table-pjud tbody tr:hover {
            background: rgba(79, 70, 229, 0.03);
        }

        /* Iconos de acci√≥n en tabla */
        .action-icons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 14px;
        }

        /* Icono azul - Ver detalle (similar a PJUD) */
        .action-btn.btn-detail {
            background: #3b82f6;
            color: white;
        }

        .action-btn.btn-detail:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        /* Icono PDF azul - Documento principal */
        .action-btn.btn-pdf-blue {
            background: #0ea5e9;
            color: white;
        }

        .action-btn.btn-pdf-blue:hover {
            background: #0284c7;
            transform: scale(1.1);
        }

        /* Icono PDF rojo - Documento anexo */
        .action-btn.btn-pdf-red {
            background: #ef4444;
            color: white;
        }

        .action-btn.btn-pdf-red:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Icono verde - eBook/Carpeta */
        .action-btn.btn-ebook {
            background: var(--secondary);
            color: white;
        }

        .action-btn.btn-ebook:hover {
            background: var(--secondary-dark);
            transform: scale(1.1);
        }

        /* Badges de estado - Colores institucionales */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-badge.en-tramite {
            background: var(--cream);
            color: var(--primary);
            border: 1px solid var(--primary-light);
        }

        .status-badge.terminada {
            background: var(--cream-dark);
            color: var(--secondary-dark);
            border: 1px solid var(--secondary);
        }

        .status-badge.suspendida {
            background: var(--cream-accent);
            color: var(--text-on-cream);
            border: 1px solid var(--cream-dark);
        }

        /* ============================================
           MODAL DETALLE - Estilo PJUD
           ============================================ */
        .modal-pjud .modal-content {
            border: none;
            border-radius: 12px;
            overflow: hidden;
        }

        .modal-pjud .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-bottom: 3px solid var(--secondary);
            padding: 15px 20px;
        }

        .modal-pjud .modal-title {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-pjud .close {
            color: white;
            opacity: 0.8;
            text-shadow: none;
        }

        .modal-pjud .modal-body {
            padding: 0;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Pesta√±as dentro del modal */
        .pjud-tabs {
            background: var(--cream-light);
            border-bottom: 3px solid var(--primary) !important;
        }

        .pjud-tabs .nav-link {
            color: var(--text-secondary);
            border: none;
            border-bottom: 3px solid transparent;
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .pjud-tabs .nav-link:hover {
            color: var(--primary);
            background: var(--cream);
        }

        .pjud-tabs .nav-link.active {
            color: var(--primary);
            background: white;
            border-bottom: 3px solid var(--secondary);
            font-weight: 600;
        }

        .pjud-tabs .nav-link i {
            margin-right: 6px;
        }

        .tab-content {
            min-height: 300px;
        }

        /* Secci√≥n de informaci√≥n en modal */
        .detail-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-section:last-child {
            border-bottom: none;
        }

        .detail-section h5 {
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid var(--cream);
            padding-bottom: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Tabla de movimientos en modal */
        .movements-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .movements-table th {
            background: var(--bg-page);
            padding: 10px 12px;
            text-align: left;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
        }

        .movements-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }

        .movements-table tbody tr:hover {
            background: var(--cream-light);
        }

        .folio-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        .etapa-tag {
            display: inline-block;
            background: #e0e7ff;
            color: #4338ca;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .table-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-input {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
            min-width: 140px;
        }
        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .pagination-info { font-size: 13px; color: var(--text-secondary); }
        .pagination-buttons { display: flex; gap: 8px; align-items: center; }
        .pagination-btn {
            padding: 6px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 13px;
        }
        .pagination-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .stats-bar {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-right: 4px; }
        .stat-value { font-size: 16px; font-weight: 600; color: var(--primary); }
        .documentos-cell { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .truncate {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ============================================
           FOOTER
           ============================================ */
        .pjud-footer {
            background: var(--bg-sidebar);
            color: var(--text-light);
            padding: 20px;
            text-align: center;
            font-size: 12px;
            margin-top: 40px;
        }

        /* ============================================
           LOADING & ESTADOS
           ============================================ */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 15px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner-pjud {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .header-main .container {
                flex-direction: column;
                gap: 15px;
            }

            .form-row-pjud {
                grid-template-columns: 1fr;
            }

            .main-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-pjud"></div>
        <span>Buscando causas...</span>
    </div>

    <!-- Header -->
    <header class="pjud-header">
        <div class="header-top">
            <div class="container">
                <span><i class="fas fa-phone-alt"></i> Soporte: Comunidad Virtual Limitada 2026 - +56 9 8509 1252</span>
                <span><i class="fas fa-clock"></i> √öltima actualizaci√≥n: <span id="lastUpdate"></span></span>
            </div>
        </div>
        <div class="header-main">
            <div class="container">
                <div class="logo-section">
                    <div class="logo-icon">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="logo-text">
                        <h1>Sistema Legal</h1>
                        <span>Consulta de Causas Judiciales</span>
                    </div>
                </div>
                <div class="user-section">
                    <div class="user-badge">
                        <i class="fas fa-user-circle"></i>
                        <span>Modo Invitado</span>
                    </div>
                </div>
            </div>
        </div>
        <nav class="nav-tabs-pjud">
            <div class="container">
                <ul class="nav nav-tabs border-0">
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-search"></i> Consulta Causas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="demo-movimientos-completo.html"><i class="fas fa-list"></i> Movimientos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mvp-dashboard.html"><i class="fas fa-chart-bar"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="modulos-erp.html"><i class="fas fa-th"></i> M√≥dulos ERP</a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Breadcrumb -->
        <div class="pjud-breadcrumb">
            <i class="fas fa-home"></i>
            <a href="#">Inicio</a>
            <span>/</span>
            <a href="#">Consultas</a>
            <span>/</span>
            <span>Consulta de Causas</span>
        </div>

        <!-- Formulario de B√∫squeda -->
        <div class="search-card">
            <div class="search-card-header">
                <h3><i class="fas fa-search"></i> B√∫squeda de Causas</h3>
                <span class="badge badge-light">Civil</span>
            </div>
            <div class="search-card-body">
                <form id="searchForm">
                    <div class="form-row-pjud">
                        <div class="form-group-pjud">
                            <label>Competencia <span class="required">*</span></label>
                            <select class="form-control-pjud" id="competencia" required>
                                <option value="">Seleccione...</option>
                                <option value="3" selected>Civil</option>
                                <option value="1">Familia</option>
                                <option value="2">Laboral</option>
                                <option value="4">Cobranza</option>
                            </select>
                        </div>
                        <div class="form-group-pjud">
                            <label>Corte de Apelaciones <span class="required">*</span></label>
                            <select class="form-control-pjud" id="corte" required>
                                <option value="">Seleccione...</option>
                                <option value="10">C.A. de Arica</option>
                                <option value="11">C.A. de Iquique</option>
                                <option value="12">C.A. de Antofagasta</option>
                                <option value="20">C.A. de Copiap√≥</option>
                                <option value="30" selected>C.A. de Valpara√≠so</option>
                                <option value="90">C.A. de Santiago</option>
                                <option value="91">C.A. de San Miguel</option>
                            </select>
                        </div>
                        <div class="form-group-pjud">
                            <label>Tribunal</label>
                            <select class="form-control-pjud" id="tribunal">
                                <option value="">Todos los tribunales</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row-pjud">
                        <div class="form-group-pjud">
                            <label>Tipo de Causa <span class="required">*</span></label>
                            <select class="form-control-pjud" id="tipoCausa" required>
                                <option value="">Seleccione...</option>
                                <option value="C" selected>C - Civil</option>
                                <option value="V">V - Voluntario</option>
                            </select>
                        </div>
                        <div class="form-group-pjud">
                            <label>N¬∞ Rol <span class="required">*</span></label>
                            <input type="number" class="form-control-pjud" id="numRol" placeholder="Ej: 3030" value="3030" required>
                        </div>
                        <div class="form-group-pjud">
                            <label>A√±o <span class="required">*</span></label>
                            <input type="number" class="form-control-pjud" id="anio" placeholder="Ej: 2017" value="2017" min="1990" max="2030" required>
                        </div>
                    </div>
                    <div class="btn-row">
                        <button type="button" class="btn-pjud btn-pjud-secondary" onclick="limpiarFormulario()">
                            <i class="fas fa-eraser"></i> Limpiar
                        </button>
                        <button type="submit" class="btn-pjud btn-pjud-primary">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla de Resultados -->
        <div class="results-card" id="resultsCard" style="display: none;">
            <div class="results-card-header">
                <h3><i class="fas fa-gavel"></i> Resultados de B√∫squeda</h3>
                <span class="results-badge" id="resultsCount">0 resultado(s)</span>
            </div>
            <div style="overflow-x: auto;">
                <table class="table-pjud">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Acciones</th>
                            <th style="width: 100px;">RIT/Rol</th>
                            <th>Caratulado</th>
                            <th style="width: 200px;">Tribunal</th>
                            <th style="width: 100px;">Fecha Ingreso</th>
                            <th style="width: 100px;">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <!-- Resultados din√°micos -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Causas de Ejemplo (datos guardados) -->
        <div class="results-card">
            <div class="results-card-header" style="background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);">
                <h3><i class="fas fa-database"></i> Causas Guardadas en Sistema</h3>
                <span class="results-badge" id="savedCount">2 causa(s)</span>
            </div>
            <div style="overflow-x: auto;">
                <table class="table-pjud">
                    <thead>
                        <tr>
                            <th style="width: 100px;">Acciones</th>
                            <th style="width: 100px;">RIT/Rol</th>
                            <th>Caratulado</th>
                            <th style="width: 200px;">Tribunal</th>
                            <th style="width: 100px;">Fecha Ingreso</th>
                            <th style="width: 100px;">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="savedCausasBody">
                        <!-- Se llena din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal Detalle de Causa -->
    <div class="modal fade modal-pjud" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-folder-open"></i> 
                        Detalle de Causa <span id="modalRit"></span>
                    </h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Informaci√≥n General (siempre visible) -->
                    <div class="detail-section" style="border-bottom: 2px solid var(--border-color);">
                        <h5><i class="fas fa-info-circle"></i> Informaci√≥n General</h5>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">RIT/Rol</span>
                                <span class="detail-value" id="detailRit">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Caratulado</span>
                                <span class="detail-value" id="detailCaratulado">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Tribunal</span>
                                <span class="detail-value" id="detailTribunal">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Fecha de Ingreso</span>
                                <span class="detail-value" id="detailFechaIngreso">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pesta√±as estilo PJUD -->
                    <ul class="nav nav-tabs pjud-tabs" role="tablist" style="border-bottom: 2px solid var(--primary); margin: 0; padding: 0 20px;">
                        <li class="nav-item">
                            <a class="nav-link active" id="tab-ebook" data-toggle="tab" href="#panel-ebook" role="tab">
                                <i class="fas fa-book"></i> eBook
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="tab-demanda" data-toggle="tab" href="#panel-demanda" role="tab">
                                <i class="fas fa-gavel"></i> Demanda
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="tab-historia" data-toggle="tab" href="#panel-historia" role="tab">
                                <i class="fas fa-history"></i> Historia Causa Cuaderno
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="tab-estados" data-toggle="tab" href="#panel-estados" role="tab">
                                <i class="fas fa-flag"></i> Estados de la Demanda
                            </a>
                        </li>
                    </ul>

                    <!-- Contenido de las pesta√±as -->
                    <div class="tab-content" style="padding: 20px;">
                        <!-- Pesta√±a: eBook -->
                        <div class="tab-pane fade show active" id="panel-ebook" role="tabpanel">
                            <div class="detail-section" style="border: none; padding: 0;">
                                <h5><i class="fas fa-book"></i> eBook / Carpeta Digital</h5>
                                <p class="text-muted small mb-3">Descarga el eBook completo de la causa con todos los documentos.</p>
                                <div class="action-icons" style="gap: 15px; flex-wrap: wrap;">
                                    <button class="action-btn btn-ebook" title="Ver eBook/Carpeta" id="btnVerEbook" style="display: none;">
                                        <i class="fas fa-eye"></i> Ver eBook
                                    </button>
                                    <button class="action-btn btn-ebook" title="Descargar eBook/Carpeta" id="btnEbook" style="display: none;">
                                        <i class="fas fa-download"></i> Descargar eBook
                                    </button>
                                    <span style="font-size: 13px; color: var(--text-secondary); margin-left: 10px;">
                                        <span id="detailPdfsCount">0</span> PDF(s) disponibles en movimientos
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Pesta√±a: Demanda -->
                        <div class="tab-pane fade" id="panel-demanda" role="tabpanel">
                            <div class="detail-section" style="border: none; padding: 0;">
                                <h5><i class="fas fa-gavel"></i> Demanda</h5>
                                <p class="text-muted small mb-3">Documento inicial de la demanda y documentos relacionados.</p>
                                <div id="demandaContent">
                                    <p class="text-muted">Cargando informaci√≥n de la demanda...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Pesta√±a: Historia Causa Cuaderno -->
                        <div class="tab-pane fade" id="panel-historia" role="tabpanel">
                            <div class="detail-section" style="border: none; padding: 0;">
                                <h5><i class="fas fa-history"></i> Historia Causa Cuaderno</h5>
                                <p class="text-muted small mb-2">Historial completo de movimientos procesales por cuaderno.</p>
                                <div id="cuadernoSection" style="display: none; margin-bottom: 15px;">
                                    <label class="detail-label">Cuaderno</label>
                                    <select class="form-control-pjud" id="filterCuaderno" style="max-width: 280px;">
                                        <option value="">Todos los cuadernos</option>
                                    </select>
                                </div>
                                <div class="table-filters" style="margin-bottom: 12px;">
                                    <input type="text" class="filter-input" id="filterFecha" placeholder="üîç Fecha...">
                                    <input type="text" class="filter-input" id="filterDescripcion" placeholder="üîç Descripci√≥n...">
                                    <select class="filter-input" id="filterEtapa">
                                        <option value="">Todas las etapas</option>
                                    </select>
                                </div>
                                <div class="table-wrapper" style="max-height: 420px; overflow: auto;">
                                    <table class="movements-table">
                                        <thead>
                                            <tr>
                                                <th style="width: 60px;">Folio</th>
                                                <th style="width: 100px;">Documentos</th>
                                                <th style="width: 95px;">Fecha</th>
                                                <th style="width: 100px;">Etapa</th>
                                                <th style="width: 110px;">Tr√°mite</th>
                                                <th>Descripci√≥n del Tr√°mite</th>
                                                <th style="width: 60px;">Foja</th>
                                            </tr>
                                        </thead>
                                        <tbody id="movimientosBody"></tbody>
                                    </table>
                                </div>
                                <div class="pagination-controls" style="padding: 12px; border-top: 1px solid var(--border-color); margin-top: 0;">
                                    <div class="pagination-info" id="paginationInfo">Mostrando 0 movimientos</div>
                                    <div class="pagination-buttons">
                                        <button type="button" class="pagination-btn" id="btnPrevMov">‚Üê Anterior</button>
                                        <span class="mx-2" id="paginaMovText">P√°g. 1</span>
                                        <button type="button" class="pagination-btn" id="btnNextMov">Siguiente ‚Üí</button>
                                    </div>
                                </div>
                                <div class="stats-bar" style="padding: 10px 0 0; border-top: 1px solid var(--border-light);">
                                    <div><span class="stat-label">Total</span> <span class="stat-value" id="statTotalMov">0</span></div>
                                    <div><span class="stat-label">Con docs</span> <span class="stat-value" id="statConDocs">0</span></div>
                                    <div><span class="stat-label">PDFs</span> <span class="stat-value" id="statPdfs">0</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Pesta√±a: Estados de la Demanda -->
                        <div class="tab-pane fade" id="panel-estados" role="tabpanel">
                            <div class="detail-section" style="border: none; padding: 0;">
                                <h5><i class="fas fa-flag"></i> Estados de la Demanda</h5>
                                <p class="text-muted small mb-3">Estados espec√≠ficos del proceso de demanda (diferente del historial de movimientos).</p>
                                <div id="estadosContent">
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <span class="detail-label">Estado Actual</span>
                                            <span class="detail-value" id="detailEstado">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Etapa</span>
                                            <span class="detail-value" id="detailEtapa">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">√öltimo Movimiento</span>
                                            <span class="detail-value" id="detailUltimoMov">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Cuadernos</span>
                                            <span class="detail-value" id="detailCuadernos">1 cuaderno</span>
                                        </div>
                                    </div>
                                    <div id="estadosList" style="margin-top: 20px;">
                                        <!-- Lista de estados se cargar√° aqu√≠ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="pjud-footer">
        <p>
            <i class="fas fa-shield-alt"></i> Sistema de Consulta de Causas | 
            Desarrollado para integraci√≥n con PJUD | 
            Soporte: Comunidad Virtual Limitada 2026 - +56 9 8509 1252 | 
            &copy; 2026
        </p>
    </footer>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ============================================
        // FUNCIONES DE MANEJO DE PDFs BASE64
        // ============================================
        
        /**
         * Decodifica un string base64 y lo descarga como PDF
         * @param {string} base64String - El string base64 del PDF
         * @param {string} nombreArchivo - Nombre del archivo a descargar
         */
        /**
         * Limpia el string base64 removiendo prefijos data: si existen
         * @param {string} base64String - String base64 (puede tener prefijo data:)
         * @returns {string} - String base64 limpio
         */
        function limpiarBase64(base64String) {
            if (!base64String) return null;
            
            // Si tiene prefijo data:application/pdf;base64, removerlo
            if (base64String.includes(',')) {
                return base64String.split(',')[1];
            }
            
            // Si tiene prefijo data:application/pdf;base64 sin coma, removerlo
            if (base64String.startsWith('data:')) {
                const parts = base64String.split(';base64');
                if (parts.length > 1) {
                    return parts[1];
                }
            }
            
            return base64String;
        }

        function descargarPDFBase64(base64String, nombreArchivo) {
            try {
                if (!base64String) {
                    mostrarNotificacion('‚ùå No hay contenido PDF disponible', 'error');
                    return;
                }

                // Limpiar base64 (remover prefijos data: si existen)
                const base64Limpio = limpiarBase64(base64String);
                if (!base64Limpio) {
                    mostrarNotificacion('‚ùå Contenido base64 inv√°lido', 'error');
                    return;
                }

                // Decodificar base64 a bytes
                let byteCharacters;
                try {
                    byteCharacters = atob(base64Limpio);
                } catch (e) {
                    console.error('Error decodificando base64:', e);
                    mostrarNotificacion('‚ùå Error: El contenido base64 no es v√°lido', 'error');
                    return;
                }
                
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                
                // Verificar que el blob tiene contenido v√°lido (magic number %PDF)
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    const uint8Array = new Uint8Array(arrayBuffer);
                    const magicNumber = String.fromCharCode(uint8Array[0], uint8Array[1], uint8Array[2], uint8Array[3]);
                    
                    if (magicNumber !== '%PDF') {
                        console.warn('‚ö†Ô∏è El contenido decodificado no parece ser un PDF v√°lido');
                    }
                };
                reader.readAsArrayBuffer(blob);
                
                // Crear enlace de descarga
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = nombreArchivo || 'documento.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                mostrarNotificacion(`‚úÖ Descargado: ${nombreArchivo}`, 'success');
            } catch (error) {
                console.error('Error al decodificar PDF:', error);
                mostrarNotificacion('‚ùå Error al descargar el PDF: ' + error.message, 'error');
            }
        }
        
        /**
         * Abre un PDF base64 en una nueva ventana/iframe
         * @param {string} base64String - El string base64 del PDF
         * @param {string} nombreArchivo - Nombre del archivo
         */
        function verPDFBase64(base64String, nombreArchivo) {
            try {
                if (!base64String) {
                    mostrarNotificacion('‚ùå No hay contenido PDF disponible', 'error');
                    return;
                }

                // Limpiar base64 (remover prefijos data: si existen)
                const base64Limpio = limpiarBase64(base64String);
                if (!base64Limpio) {
                    mostrarNotificacion('‚ùå Contenido base64 inv√°lido', 'error');
                    return;
                }

                let byteCharacters;
                try {
                    byteCharacters = atob(base64Limpio);
                } catch (e) {
                    console.error('Error decodificando base64:', e);
                    mostrarNotificacion('‚ùå Error: El contenido base64 no es v√°lido', 'error');
                    return;
                }

                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                // Abrir en nueva ventana con iframe
                const ventanaPDF = window.open('', '_blank');
                if (ventanaPDF) {
                    ventanaPDF.document.write(`
                        <!DOCTYPE html>
                        <html>
                            <head>
                                <title>${nombreArchivo || 'PDF'}</title>
                                <style>
                                    * { margin: 0; padding: 0; box-sizing: border-box; }
                                    body { overflow: hidden; }
                                    iframe { width: 100vw; height: 100vh; border: none; }
                                </style>
                            </head>
                            <body>
                                <iframe src="${url}"></iframe>
                            </body>
                        </html>
                    `);
                    ventanaPDF.document.close();
                } else {
                    // Si no se puede abrir ventana (popup bloqueado), descargar
                    descargarPDFBase64(base64String, nombreArchivo);
                }
            } catch (error) {
                console.error('Error al abrir PDF:', error);
                mostrarNotificacion('‚ùå Error al abrir el PDF: ' + error.message, 'error');
            }
        }
        
        /**
         * Muestra una notificaci√≥n temporal
         * @param {string} mensaje - Mensaje a mostrar
         * @param {string} tipo - 'success', 'error', 'info'
         */
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const colores = {
                success: '#10b981',
                error: '#ef4444',
                info: '#3b82f6'
            };
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${colores[tipo] || colores.info};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 9999;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = mensaje;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Agregar estilos de animaci√≥n
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(styleSheet);

        // ============================================
        // DATOS DE CAUSAS CON PDFs EN BASE64
        // ============================================
        
        // Datos de causas guardadas (con PDFs en base64)
        // En producci√≥n, estos datos vendr√≠an de la API/BD
        const causasGuardadas = [
            {
                rit: "C-3030-2017",
                caratulado: "ESPINOZA/TRANSPORTES PLAZUELA ECUADOR S.A",
                tribunal: "5¬∫ Juzgado Civil de Valpara√≠so",
                fechaIngreso: "27/11/2017",
                estado: "EN_TRAMITE",
                movimientos: [
                    { 
                        folio: 1, 
                        fecha: "27/11/2017", 
                        etapa: "Ingreso", 
                        tramite: "Ingreso",
                        descripcion: "Ingreso de demanda",
                        foja: "1",
                        pdf_azul: {
                            nombre: "C_3030_2017_mov_1_azul.pdf",
                            // En producci√≥n, aqu√≠ ir√≠a el base64 real
                            base64: null, // Se llenar√° con datos reales del scraping
                            tipo: "application/pdf"
                        },
                        pdf_rojo: null,
                        tiene_pdf_azul: true,
                        tiene_pdf_rojo: false
                    },
                    { 
                        folio: 2, 
                        fecha: "28/11/2017", 
                        etapa: "Providencia", 
                        tramite: "Providencia",
                        descripcion: "Se tiene por presentada la demanda",
                        foja: "2",
                        pdf_azul: {
                            nombre: "C_3030_2017_mov_2_azul.pdf",
                            base64: null,
                            tipo: "application/pdf"
                        },
                        pdf_rojo: {
                            nombre: "C_3030_2017_mov_2_rojo.pdf",
                            base64: null,
                            tipo: "application/pdf"
                        },
                        tiene_pdf_azul: true,
                        tiene_pdf_rojo: true
                    },
                    { 
                        folio: 3, 
                        fecha: "05/12/2017", 
                        etapa: "Notificaci√≥n", 
                        tramite: "Notificaci√≥n",
                        descripcion: "Notificaci√≥n personal al demandado",
                        foja: "3",
                        pdf_azul: null,
                        pdf_rojo: null,
                        tiene_pdf_azul: false,
                        tiene_pdf_rojo: false
                    },
                    { 
                        folio: 4, 
                        fecha: "15/12/2017", 
                        etapa: "Contestaci√≥n", 
                        tramite: "Contestaci√≥n",
                        descripcion: "Se presenta contestaci√≥n de demanda",
                        foja: "4",
                        pdf_azul: {
                            nombre: "C_3030_2017_mov_4_azul.pdf",
                            base64: null,
                            tipo: "application/pdf"
                        },
                        pdf_rojo: null,
                        tiene_pdf_azul: true,
                        tiene_pdf_rojo: false
                    },
                    { 
                        folio: 5, 
                        fecha: "20/12/2017", 
                        etapa: "R√©plica", 
                        tramite: "R√©plica",
                        descripcion: "Escrito de r√©plica del demandante",
                        foja: "5",
                        pdf_azul: {
                            nombre: "C_3030_2017_mov_5_azul.pdf",
                            base64: null,
                            tipo: "application/pdf"
                        },
                        pdf_rojo: null,
                        tiene_pdf_azul: true,
                        tiene_pdf_rojo: false
                    },
                    { 
                        folio: 6, 
                        fecha: "28/12/2017", 
                        etapa: "Tramitaci√≥n", 
                        tramite: "Citaci√≥n",
                        descripcion: "Se cita a audiencia de conciliaci√≥n",
                        foja: "6",
                        pdf_azul: null,
                        pdf_rojo: null,
                        tiene_pdf_azul: false,
                        tiene_pdf_rojo: false
                    }
                ],
                totalPdfs: 5,
                tieneEbook: true,
                ebook: {
                    nombre: "C_3030_2017_ebook.pdf",
                    base64: null,
                    tipo: "application/pdf"
                }
            },
            {
                rit: "C-571-2019",
                caratulado: "HERRERA/LANDERO",
                tribunal: "Juzgado de Letras de San Javier",
                fechaIngreso: "27/05/2019",
                estado: "EN_TRAMITE",
                movimientos: [
                    { 
                        folio: 1, 
                        fecha: "27/05/2019", 
                        etapa: "Ingreso", 
                        descripcion: "Se ingresa demanda civil",
                        pdf_azul: {
                            nombre: "C_571_2019_mov_1_azul.pdf",
                            base64: null,
                            tipo: "application/pdf"
                        },
                        pdf_rojo: null,
                        tiene_pdf_azul: true,
                        tiene_pdf_rojo: false
                    },
                    { 
                        folio: 2, 
                        fecha: "28/05/2019", 
                        etapa: "Providencia", 
                        descripcion: "A lo principal t√©ngase por presentada demanda",
                        pdf_azul: {
                            nombre: "C_571_2019_mov_2_azul.pdf",
                            base64: null,
                            tipo: "application/pdf"
                        },
                        pdf_rojo: null,
                        tiene_pdf_azul: true,
                        tiene_pdf_rojo: false
                    },
                    { 
                        folio: 3, 
                        fecha: "10/06/2019", 
                        etapa: "Notificaci√≥n", 
                        descripcion: "Certificaci√≥n de notificaci√≥n",
                        pdf_azul: null,
                        pdf_rojo: null,
                        tiene_pdf_azul: false,
                        tiene_pdf_rojo: false
                    },
                    { 
                        folio: 4, 
                        fecha: "25/06/2019", 
                        etapa: "Tramitaci√≥n", 
                        descripcion: "Se declara rebeld√≠a del demandado",
                        pdf_azul: {
                            nombre: "C_571_2019_mov_4_azul.pdf",
                            base64: null,
                            tipo: "application/pdf"
                        },
                        pdf_rojo: null,
                        tiene_pdf_azul: true,
                        tiene_pdf_rojo: false
                    }
                ],
                totalPdfs: 3,
                tieneEbook: false,
                ebook: null
            }
        ];

        // Variable para almacenar la causa actual en el modal
        let causaActual = null;
        let modalMovimientos = [];
        let filteredModalMovimientos = [];
        let modalPage = 1;
        const modalPageSize = 25;

        // Actualizar fecha
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-CL');

        // ============================================
        // FUNCIONES DE RENDERIZADO
        // ============================================

        function applyModalFilters(resetPage) {
            const fecha = (document.getElementById('filterFecha')?.value || '').toLowerCase();
            const desc = (document.getElementById('filterDescripcion')?.value || '').toLowerCase();
            const etapa = document.getElementById('filterEtapa')?.value || '';
            const cuaderno = document.getElementById('filterCuaderno')?.value || '';
            filteredModalMovimientos = modalMovimientos.filter(m => {
                const matchFecha = !fecha || (m.fecha || '').toLowerCase().includes(fecha);
                const matchDesc = !desc || (m.descripcion || m.desc_tramite || '').toLowerCase().includes(desc);
                const matchEtapa = !etapa || (m.etapa || '') === etapa;
                const matchCuaderno = !cuaderno || (m.id_cuaderno || '') === cuaderno;
                return matchFecha && matchDesc && matchEtapa && matchCuaderno;
            });
            if (resetPage !== false) modalPage = 1;
        }

        function renderModalMovimientos(resetPage) {
            applyModalFilters(resetPage !== false);
            const total = filteredModalMovimientos.length;
            const totalPages = Math.max(1, Math.ceil(total / modalPageSize));
            const start = (modalPage - 1) * modalPageSize;
            const slice = filteredModalMovimientos.slice(start, start + modalPageSize);
            const cause = causaActual;
            if (!cause) return;

            const tbody = document.getElementById('movimientosBody');
            tbody.innerHTML = slice.map((mov, idx) => {
                const i = modalMovimientos.indexOf(mov);
                const folio = mov.folio ?? mov.indice ?? '-';
                const fecha = mov.fecha ?? '-';
                const etapa = mov.etapa ?? '';
                const tramite = mov.tramite ?? mov.tipo_movimiento ?? '';
                const desc = mov.descripcion ?? mov.desc_tramite ?? '';
                const foja = mov.foja ?? '-';
                const hasAzul = mov.tiene_pdf_azul ?? !!mov.pdf_azul;
                const hasRojo = mov.tiene_pdf_rojo ?? !!mov.pdf_rojo;
                
                // Detectar si es "Actuaci√≥n Receptor" para mostrar en rojo
                const esActuacionReceptor = tramite && tramite.toLowerCase().includes('actuaci√≥n receptor');
                const tramiteStyle = esActuacionReceptor ? 'style="color: #c62828; font-weight: 600;"' : '';
                const tramiteHTML = esActuacionReceptor 
                    ? `<span ${tramiteStyle}>${tramite}</span>` 
                    : tramite;
                
                return `
                <tr data-id-pagina="${mov.id_pagina || ''}" data-id-cuaderno="${mov.id_cuaderno || ''}">
                    <td><span class="folio-badge">${folio}</span></td>
                    <td>
                        <div class="documentos-cell" style="display: flex; gap: 4px; align-items: center; flex-wrap: wrap;">
                            ${hasAzul ? `
                                <button class="action-btn btn-pdf-blue" title="Ver PDF Principal (Azul)" style="width:24px;height:24px;font-size:11px;padding:0;" onclick="verPDF('${cause.rit}', ${i}, 'azul')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn btn-pdf-blue" title="Descargar PDF Principal (Azul)" style="width:24px;height:24px;font-size:11px;padding:0;" onclick="descargarPDF('${cause.rit}', ${i}, 'azul')">
                                    <i class="fas fa-download"></i>
                                </button>
                            ` : ''}
                            ${hasRojo ? `
                                <button class="action-btn btn-pdf-red" title="Ver PDF Anexo (Rojo)" style="width:24px;height:24px;font-size:11px;padding:0;" onclick="verPDF('${cause.rit}', ${i}, 'rojo')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn btn-pdf-red" title="Descargar PDF Anexo (Rojo)" style="width:24px;height:24px;font-size:11px;padding:0;" onclick="descargarPDF('${cause.rit}', ${i}, 'rojo')">
                                    <i class="fas fa-download"></i>
                                </button>
                            ` : ''}
                            ${!hasAzul && !hasRojo ? '<span style="color:#999;font-size:11px;">-</span>' : ''}
                        </div>
                    </td>
                    <td>${fecha}</td>
                    <td>${etapa ? `<span class="etapa-tag">${etapa}</span>` : ''}</td>
                    <td>${tramiteHTML}</td>
                    <td><div class="truncate" title="${desc}">${desc}</div></td>
                    <td style="text-align:center;color:var(--text-muted);">${foja}</td>
                </tr>`;
            }).join('');

            document.getElementById('paginationInfo').textContent = `Mostrando ${total ? start + 1 : 0} - ${Math.min(start + modalPageSize, total)} de ${total} movimientos`;
            document.getElementById('paginaMovText').textContent = `P√°g. ${modalPage} de ${totalPages}`;
            document.getElementById('btnPrevMov').disabled = modalPage <= 1;
            document.getElementById('btnNextMov').disabled = modalPage >= totalPages;
            document.getElementById('statTotalMov').textContent = modalMovimientos.length;
            document.getElementById('statConDocs').textContent = modalMovimientos.filter(m => m.tiene_pdf_azul || m.tiene_pdf_rojo || m.pdf_azul || m.pdf_rojo).length;
            document.getElementById('statPdfs').textContent = cause.totalPdfs ?? modalMovimientos.filter(m => m.tiene_pdf_azul || m.tiene_pdf_rojo).length;
        }

        // Renderizar causas guardadas
        function renderizarCausasGuardadas() {
            const tbody = document.getElementById('savedCausasBody');
            tbody.innerHTML = causasGuardadas.map(causa => `
                <tr>
                    <td>
                        <div class="action-icons">
                            <button class="action-btn btn-detail" title="Ver detalle" onclick="verDetalle('${causa.rit}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${causa.tieneEbook ? `
                            <button class="action-btn btn-ebook" title="Descargar eBook" onclick="descargarEbook('${causa.rit}')">
                                <i class="fas fa-book"></i>
                            </button>
                            ` : ''}
                            ${causa.totalPdfs > 0 ? `
                            <button class="action-btn btn-pdf-blue" title="${causa.totalPdfs} PDF(s) disponibles" onclick="verDetalle('${causa.rit}')">
                                <i class="fas fa-file-pdf"></i>
                            </button>
                            ` : ''}
                        </div>
                    </td>
                    <td><strong>${causa.rit}</strong></td>
                    <td>${causa.caratulado}</td>
                    <td>${causa.tribunal}</td>
                    <td>${causa.fechaIngreso}</td>
                    <td>
                        <span class="status-badge ${causa.estado === 'EN_TRAMITE' ? 'en-tramite' : 'terminada'}">
                            ${causa.estado === 'EN_TRAMITE' ? 'En Tr√°mite' : 'Terminada'}
                        </span>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('savedCount').textContent = `${causasGuardadas.length} causa(s)`;
        }

        // Ver detalle de causa
        function verDetalle(rit) {
            const causa = causasGuardadas.find(c => c.rit === rit);
            if (!causa) return;

            causaActual = causa;
            
            // Obtener cuadernos primero (antes de usarlos)
            const cuadernos = causa.cuadernos || [];
            
            // Mapear movimientos incluyendo PDFs
            modalMovimientos = (causa.movimientos || []).map(m => ({
                ...m,
                fecha: m.fecha ?? m.fec_tramite,
                etapa: m.etapa ?? m.etapa_codigo,
                tramite: m.tramite ?? m.tipo_movimiento,
                descripcion: m.descripcion ?? m.desc_tramite,
                foja: m.foja,
                id_pagina: m.id_pagina,
                id_cuaderno: m.id_cuaderno,
                cuaderno_nombre: m.cuaderno_nombre,
                // Asegurar que los PDFs se incluyan
                pdf_azul: m.pdf_azul,
                pdf_rojo: m.pdf_rojo,
                tiene_pdf_azul: m.tiene_pdf_azul ?? !!m.pdf_azul,
                tiene_pdf_rojo: m.tiene_pdf_rojo ?? !!m.pdf_rojo
            }));

            document.getElementById('modalRit').textContent = causa.rit;
            document.getElementById('detailRit').textContent = causa.rit;
            document.getElementById('detailCaratulado').textContent = causa.caratulado;
            document.getElementById('detailTribunal').textContent = causa.tribunal;
            document.getElementById('detailFechaIngreso').textContent = causa.fechaIngreso;
            document.getElementById('detailEstado').innerHTML = `
                <span class="status-badge ${causa.estado === 'EN_TRAMITE' ? 'en-tramite' : 'terminada'}">
                    ${causa.estado === 'EN_TRAMITE' ? 'En Tr√°mite' : 'Terminada'}
                </span>
            `;
            const last = causa.movimientos[causa.movimientos.length - 1];
            document.getElementById('detailEtapa').textContent = last?.etapa || last?.etapa_codigo || '-';
            document.getElementById('detailUltimoMov').textContent = last?.fecha || last?.fec_tramite || '-';
            document.getElementById('detailPdfsCount').textContent = causa.totalPdfs ?? 0;
            
            // Mostrar informaci√≥n de cuadernos
            const numCuadernos = cuadernos.length || 1;
            const cuadernoText = numCuadernos === 1 
                ? '1 cuaderno (Principal)' 
                : `${numCuadernos} cuadernos`;
            document.getElementById('detailCuadernos').textContent = cuadernoText;

            const etapas = [...new Set(modalMovimientos.map(m => m.etapa).filter(Boolean))].sort();
            const selEtapa = document.getElementById('filterEtapa');
            selEtapa.innerHTML = '<option value="">Todas las etapas</option>' + etapas.map(e => `<option value="${e}">${e}</option>`).join('');

            const cuadernoSection = document.getElementById('cuadernoSection');
            const selCuaderno = document.getElementById('filterCuaderno');
            // Mostrar selector solo si hay m√°s de 1 cuaderno
            if (cuadernos.length > 1) {
                cuadernoSection.style.display = 'block';
                selCuaderno.innerHTML = '<option value="">Todos los cuadernos</option>' +
                    cuadernos.map(c => `<option value="${c.id_cuaderno}">${c.nombre} (${c.movimientos?.length || 0})</option>`).join('');
            } else {
                cuadernoSection.style.display = 'none';
                selCuaderno.innerHTML = '<option value="">Todos los cuadernos</option>';
            }

            document.getElementById('filterFecha').value = '';
            document.getElementById('filterDescripcion').value = '';

            renderModalMovimientos();

            const btnEbook = document.getElementById('btnEbook');
            const btnVerEbook = document.getElementById('btnVerEbook');
            const tieneEbook = causa.tieneEbook && causa.ebook;
            
            if (tieneEbook) {
                btnEbook.style.display = 'flex';
                btnVerEbook.style.display = 'flex';
                btnEbook.onclick = () => descargarEbook(causa.rit);
                btnVerEbook.onclick = () => verEbook(causa.rit);
            } else {
                btnEbook.style.display = 'none';
                btnVerEbook.style.display = 'none';
            }

            // Cargar contenido de pesta√±as
            cargarContenidoDemanda(causa);
            cargarContenidoEstados(causa);

            // Activar primera pesta√±a (eBook)
            $('.pjud-tabs .nav-link').first().tab('show');

            $('#modalDetalle').modal('show');
        }

        // Cargar contenido de la pesta√±a "Demanda"
        function cargarContenidoDemanda(causa) {
            const demandaContent = document.getElementById('demandaContent');
            if (!demandaContent) return;

            // Buscar movimientos relacionados con la demanda (primeros movimientos o movimientos con "demanda" en descripci√≥n)
            const movimientosDemanda = (causa.movimientos || []).filter(m => {
                const desc = (m.descripcion || m.desc_tramite || '').toLowerCase();
                return desc.includes('demanda') || desc.includes('ingreso') || m.indice <= 3;
            }).slice(0, 5); // Primeros 5 movimientos relacionados

            if (movimientosDemanda.length === 0) {
                demandaContent.innerHTML = '<p class="text-muted">No se encontraron movimientos relacionados con la demanda.</p>';
                return;
            }

            let html = '<div class="table-wrapper" style="max-height: 400px; overflow: auto;">';
            html += '<table class="movements-table">';
            html += '<thead><tr><th>Folio</th><th>Fecha</th><th>Etapa</th><th>Tr√°mite</th><th>Descripci√≥n</th><th>Documentos</th></tr></thead>';
            html += '<tbody>';

            movimientosDemanda.forEach((mov, idx) => {
                const hasAzul = mov.tiene_pdf_azul ?? !!mov.pdf_azul;
                const hasRojo = mov.tiene_pdf_rojo ?? !!mov.pdf_rojo;
                const tramite = mov.tramite ?? mov.tipo_movimiento ?? '';
                const esActuacionReceptor = tramite && tramite.toLowerCase().includes('actuaci√≥n receptor');
                const tramiteHTML = esActuacionReceptor 
                    ? `<span style="color: #c62828; font-weight: 600;">${tramite}</span>` 
                    : tramite;
                
                html += `<tr>
                    <td><span class="folio-badge">${mov.folio || mov.indice || '-'}</span></td>
                    <td>${mov.fecha || '-'}</td>
                    <td>${mov.etapa || '-'}</td>
                    <td>${tramiteHTML || '-'}</td>
                    <td>${mov.descripcion || mov.desc_tramite || '-'}</td>
                    <td>
                        <div style="display: flex; gap: 4px;">
                            ${hasAzul ? `<button class="action-btn btn-pdf-blue" title="Ver PDF Principal" onclick="verPDF('${causa.rit}', ${causa.movimientos.indexOf(mov)}, 'azul')" style="width:24px;height:24px;font-size:11px;padding:0;"><i class="fas fa-file-pdf"></i></button>` : ''}
                            ${hasRojo ? `<button class="action-btn btn-pdf-red" title="Ver PDF Anexo" onclick="verPDF('${causa.rit}', ${causa.movimientos.indexOf(mov)}, 'rojo')" style="width:24px;height:24px;font-size:11px;padding:0;"><i class="fas fa-file-pdf"></i></button>` : ''}
                        </div>
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            demandaContent.innerHTML = html;
        }

        // Cargar contenido de la pesta√±a "Estados de la Demanda"
        function cargarContenidoEstados(causa) {
            const estadosList = document.getElementById('estadosList');
            if (!estadosList) return;

            // Obtener estados √∫nicos de los movimientos (diferente de historia)
            const estadosUnicos = [...new Set((causa.movimientos || []).map(m => m.etapa).filter(Boolean))];
            
            let html = '<div class="info-grid" style="margin-top: 15px;">';
            
            estadosUnicos.forEach((estado, idx) => {
                const movimientosEstado = causa.movimientos.filter(m => m.etapa === estado);
                const ultimoEstado = movimientosEstado[movimientosEstado.length - 1];
                
                html += `<div class="info-card" style="padding: 15px; border-left: 4px solid var(--primary);">
                    <h6 style="color: var(--primary); margin-bottom: 10px;">${estado}</h6>
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        <div><strong>Movimientos:</strong> ${movimientosEstado.length}</div>
                        ${ultimoEstado ? `<div><strong>√öltimo:</strong> ${ultimoEstado.fecha || '-'}</div>` : ''}
                        ${ultimoEstado ? `<div><strong>Descripci√≥n:</strong> ${(ultimoEstado.descripcion || ultimoEstado.desc_tramite || '-').substring(0, 80)}...</div>` : ''}
                    </div>
                </div>`;
            });

            html += '</div>';
            estadosList.innerHTML = estadosUnicos.length > 0 ? html : '<p class="text-muted">No hay estados registrados.</p>';
        }

        function setupModalFiltersAndPagination() {
            $('#filterFecha, #filterDescripcion').off('input').on('input', () => renderModalMovimientos());
            $('#filterEtapa, #filterCuaderno').off('change').on('change', () => renderModalMovimientos());
            $('#btnPrevMov').off('click').on('click', () => { if (modalPage > 1) { modalPage--; renderModalMovimientos(false); } });
            $('#btnNextMov').off('click').on('click', () => {
                const totalPages = Math.max(1, Math.ceil(filteredModalMovimientos.length / modalPageSize));
                if (modalPage < totalPages) { modalPage++; renderModalMovimientos(false); }
            });
        }

        // ============================================
        // FUNCIONES DE DESCARGA
        // ============================================

        /**
         * Descarga un PDF de un movimiento espec√≠fico
         * @param {string} rit - RIT de la causa
         * @param {number} movIndex - √çndice del movimiento
         * @param {string} tipo - 'azul' o 'rojo'
         */
        function descargarPDF(rit, movIndex, tipo) {
            const causa = causasGuardadas.find(c => c.rit === rit);
            if (!causa) {
                mostrarNotificacion('‚ùå Causa no encontrada', 'error');
                return;
            }

            const mov = causa.movimientos[movIndex];
            if (!mov) {
                mostrarNotificacion('‚ùå Movimiento no encontrado', 'error');
                return;
            }

            const pdfData = tipo === 'azul' ? mov.pdf_azul : mov.pdf_rojo;
            
            if (!pdfData) {
                mostrarNotificacion(`‚ùå No hay PDF ${tipo} disponible`, 'error');
                return;
            }

            if (pdfData.base64) {
                // Tiene base64, descargar directamente
                // Asegurarse de que base64 es un string
                const base64Content = typeof pdfData.base64 === 'string' ? pdfData.base64 : String(pdfData.base64);
                const nombre = pdfData.nombre || `${rit}_mov_${mov.folio || movIndex}_${tipo}.pdf`;
                descargarPDFBase64(base64Content, nombre);
            } else if (pdfData.nombre) {
                // No tiene base64 pero tiene nombre, intentar cargar desde servidor
                mostrarNotificacion('üìÑ Cargando PDF desde servidor...', 'info');
                fetch(`/api/scraping/pdf/${rit}/${pdfData.nombre}`)
                    .then(res => {
                        if (res.ok) return res.blob();
                        throw new Error('PDF no encontrado');
                    })
                    .then(blob => {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = pdfData.nombre;
                        link.click();
                        URL.revokeObjectURL(url);
                        mostrarNotificacion(`‚úÖ Descargado: ${pdfData.nombre}`, 'success');
                    })
                    .catch(() => {
                        mostrarNotificacion(`‚ùå No se pudo descargar: ${pdfData.nombre}`, 'error');
                    });
            } else {
                mostrarNotificacion(`üìÑ PDF ${tipo} no disponible`, 'warning');
            }
        }

        /**
         * Abre un PDF de un movimiento en una nueva ventana
         * @param {string} rit - RIT de la causa
         * @param {number} index - √çndice del movimiento
         * @param {string} tipo - 'azul' o 'rojo'
         */
        function verPDF(rit, index, tipo) {
            const causa = causasGuardadas.find(c => c.rit === rit);
            if (!causa || !causa.movimientos || !causa.movimientos[index]) {
                mostrarNotificacion('‚ùå Movimiento no encontrado', 'error');
                return;
            }

            const mov = causa.movimientos[index];
            const pdfData = tipo === 'azul' ? mov.pdf_azul : mov.pdf_rojo;
            
            if (!pdfData) {
                mostrarNotificacion(`‚ùå No hay PDF ${tipo} disponible`, 'error');
                return;
            }

            if (pdfData.base64) {
                // Asegurarse de que base64 es un string
                const base64Content = typeof pdfData.base64 === 'string' ? pdfData.base64 : String(pdfData.base64);
                const nombre = pdfData.nombre || `${rit}_mov_${mov.folio || index}_${tipo}.pdf`;
                verPDFBase64(base64Content, nombre);
            } else if (pdfData.nombre) {
                // Abrir desde servidor
                window.open(`/api/scraping/pdf/${rit}/${pdfData.nombre}`, '_blank');
            } else {
                mostrarNotificacion(`üìÑ PDF ${tipo} no disponible`, 'warning');
            }
        }

        /**
         * Descarga el eBook de una causa
         * @param {string} rit - RIT de la causa
         */
        function descargarEbook(rit) {
            const causa = causasGuardadas.find(c => c.rit === rit);
            if (!causa || !causa.ebook) {
                mostrarNotificacion('‚ùå eBook no disponible', 'error');
                return;
            }

            if (causa.ebook && causa.ebook.base64) {
                // Tiene base64, descargar directamente
                const nombre = causa.ebook.nombre || `${rit}_ebook.pdf`;
                descargarPDFBase64(causa.ebook.base64, nombre);
            } else if (causa.ebook && causa.ebook.nombre) {
                // Tiene nombre pero no base64, intentar cargar desde servidor
                mostrarNotificacion('üìö Cargando eBook desde servidor...', 'info');
                fetch(`/api/scraping/pdf/${rit}/${causa.ebook.nombre}`)
                    .then(res => {
                        if (res.ok) return res.blob();
                        throw new Error('eBook no encontrado');
                    })
                    .then(blob => {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = causa.ebook.nombre || `${rit}_ebook.pdf`;
                        link.click();
                        URL.revokeObjectURL(url);
                        mostrarNotificacion(`‚úÖ eBook descargado: ${causa.ebook.nombre}`, 'success');
                    })
                    .catch(() => {
                        mostrarNotificacion(`‚ùå No se pudo descargar el eBook`, 'error');
                    });
            } else {
                mostrarNotificacion(`üìö eBook no disponible para ${rit}`, 'warning');
            }
        }

        /**
         * Abre el eBook en una nueva ventana
         */
        function verEbook(rit) {
            const causa = causasGuardadas.find(c => c.rit === rit);
            if (!causa || !causa.ebook) {
                mostrarNotificacion('‚ùå eBook no disponible', 'error');
                return;
            }

            if (causa.ebook.base64) {
                const nombre = causa.ebook.nombre || `${rit}_ebook.pdf`;
                verPDFBase64(causa.ebook.base64, nombre);
            } else if (causa.ebook.nombre) {
                window.open(`/api/scraping/pdf/${rit}/${causa.ebook.nombre}`, '_blank');
            } else {
                mostrarNotificacion('üìö eBook no disponible', 'warning');
            }
        }

        // ============================================
        // B√öSQUEDA
        // ============================================

        // Buscar causas
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const loading = document.getElementById('loadingOverlay');
            loading.classList.add('active');

            setTimeout(() => {
                loading.classList.remove('active');
                
                const resultsCard = document.getElementById('resultsCard');
                const resultsBody = document.getElementById('resultsBody');
                
                const numRol = document.getElementById('numRol').value;
                const anio = document.getElementById('anio').value;
                const rit = `C-${numRol}-${anio}`;
                
                const causaEncontrada = causasGuardadas.find(c => c.rit === rit);
                
                if (causaEncontrada) {
                    resultsBody.innerHTML = `
                        <tr>
                            <td>
                                <div class="action-icons">
                                    <button class="action-btn btn-detail" title="Ver detalle" onclick="verDetalle('${causaEncontrada.rit}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${causaEncontrada.tieneEbook ? `
                                    <button class="action-btn btn-ebook" title="Descargar eBook" onclick="descargarEbook('${causaEncontrada.rit}')">
                                        <i class="fas fa-book"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            </td>
                            <td><strong>${causaEncontrada.rit}</strong></td>
                            <td>${causaEncontrada.caratulado}</td>
                            <td>${causaEncontrada.tribunal}</td>
                            <td>${causaEncontrada.fechaIngreso}</td>
                            <td>
                                <span class="status-badge en-tramite">En Tr√°mite</span>
                            </td>
                        </tr>
                    `;
                    document.getElementById('resultsCount').textContent = '1 resultado(s)';
                } else {
                    resultsBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-search" style="font-size: 40px; color: #ccc; margin-bottom: 15px; display: block;"></i>
                                <p style="color: #999; margin: 0;">No se encontraron resultados para RIT: ${rit}</p>
                                <small style="color: #ccc;">Intente con otra b√∫squeda o verifique los datos ingresados</small>
                            </td>
                        </tr>
                    `;
                    document.getElementById('resultsCount').textContent = '0 resultado(s)';
                }
                
                resultsCard.style.display = 'block';
            }, 1500);
        });

        // Limpiar formulario
        function limpiarFormulario() {
            document.getElementById('searchForm').reset();
            document.getElementById('resultsCard').style.display = 'none';
        }

        // ============================================
        // CARGAR DATOS DESDE ARCHIVOS JSON
        // ============================================

        /**
         * Carga los datos de causas desde los archivos JSON generados por el scraping
         * Busca autom√°ticamente todos los archivos disponibles
         */
        async function cargarCausasDesdeJSON() {
            try {
                mostrarNotificacion('üîÑ Cargando causas desde archivos JSON...', 'info');
                
                // Primero intentar listar todos los RITs disponibles desde la API
                let ritsDisponibles = [];
                try {
                    const listResponse = await fetch('/api/scraping/listar', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    if (listResponse.ok) {
                        const listData = await listResponse.json();
                        ritsDisponibles = (listData.rits || []).map(r => r.rit || r).filter(Boolean);
                        console.log(`üìã Encontrados ${ritsDisponibles.length} RITs desde API`);
                    }
                } catch (e) {
                    console.log('‚ö†Ô∏è No se pudo obtener lista de RITs desde API:', e.message);
                }

                // Si no hay lista, usar lista por defecto de causas de prueba (con datos en BD)
                if (ritsDisponibles.length === 0) {
                    ritsDisponibles = ['C-571-2018', 'C-8234-2020', 'C-3443-2020'];
                    console.log('üìã Usando lista por defecto de causas de prueba (con PDFs en BD)');
                }

                const causasCargadas = [];
                let cargadas = 0;
                let errores = 0;

                // Cargar cada RIT disponible
                for (const rit of ritsDisponibles) {
                    try {
                        const response = await fetch(`/api/scraping/resultado/${rit}`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const apiData = await response.json();
                            const data = apiData.resultado || apiData;
                            
                            if (!data || !data.rit) {
                                console.warn(`‚ö†Ô∏è ${rit}: Datos incompletos`, data);
                                continue;
                            }

                            console.log(`üì¶ Cargando ${rit}:`, {
                                total_movimientos: data.movimientos?.length || 0,
                                fuente: apiData.fuente || 'unknown'
                            });

                            // Transformar datos del formato del scraper/BD al formato del frontend
                            const movs = (data.movimientos || []).map(mov => {
                                // Extraer PDFs base64 del movimiento
                                let pdfAzul = mov.pdf_azul;
                                let pdfRojo = mov.pdf_rojo;
                                
                                // Si pdf_azul es un objeto con base64, preservarlo tal cual
                                if (pdfAzul && typeof pdfAzul === 'object' && pdfAzul.base64) {
                                    // Ya tiene base64, preservar objeto completo
                                    pdfAzul = {
                                        nombre: pdfAzul.nombre || `${data.rit}_mov_${mov.folio || mov.indice}_azul.pdf`,
                                        base64: pdfAzul.base64,
                                        tipo: pdfAzul.tipo || 'application/pdf',
                                        tama√±o_kb: pdfAzul.tama√±o_kb || null
                                    };
                                } else if (pdfAzul && typeof pdfAzul === 'string') {
                                    // Es solo un nombre, buscar en data.pdfs
                                    const pdfData = data.pdfs?.[pdfAzul];
                                    if (pdfData && typeof pdfData === 'string') {
                                        pdfAzul = { nombre: pdfAzul, base64: pdfData, tipo: 'application/pdf' };
                                    } else {
                                        pdfAzul = { nombre: pdfAzul, base64: null, tipo: 'application/pdf' };
                                    }
                                } else if (mov.pdf_principal) {
                                    // Fallback a pdf_principal
                                    pdfAzul = {
                                        nombre: mov.pdf_principal_nombre || mov.pdf_principal,
                                        base64: data.pdfs?.[mov.pdf_principal] || null,
                                        tipo: 'application/pdf'
                                    };
                                } else {
                                    pdfAzul = null;
                                }
                                
                                // Mismo proceso para pdf_rojo
                                if (pdfRojo && typeof pdfRojo === 'object' && pdfRojo.base64) {
                                    // Ya tiene base64, preservar objeto completo
                                    pdfRojo = {
                                        nombre: pdfRojo.nombre || `${data.rit}_mov_${mov.folio || mov.indice}_rojo.pdf`,
                                        base64: pdfRojo.base64,
                                        tipo: pdfRojo.tipo || 'application/pdf',
                                        tama√±o_kb: pdfRojo.tama√±o_kb || null
                                    };
                                } else if (pdfRojo && typeof pdfRojo === 'string') {
                                    const pdfData = data.pdfs?.[pdfRojo];
                                    if (pdfData && typeof pdfData === 'string') {
                                        pdfRojo = { nombre: pdfRojo, base64: pdfData, tipo: 'application/pdf' };
                                    } else {
                                        pdfRojo = { nombre: pdfRojo, base64: null, tipo: 'application/pdf' };
                                    }
                                } else if (mov.pdf_anexo) {
                                    pdfRojo = {
                                        nombre: mov.pdf_anexo_nombre || mov.pdf_anexo,
                                        base64: data.pdfs?.[mov.pdf_anexo] || null,
                                        tipo: 'application/pdf'
                                    };
                                } else {
                                    pdfRojo = null;
                                }

                                return {
                                    folio: mov.folio || mov.indice,
                                    fecha: mov.fecha || mov.fec_tramite || '-',
                                    etapa: mov.etapa || mov.etapa_codigo || 'TRAMITACION',
                                    tramite: mov.tramite || mov.tipo_movimiento,
                                    descripcion: mov.descripcion || mov.desc_tramite || mov.tipo_movimiento || '-',
                                    foja: mov.foja,
                                    id_pagina: mov.id_pagina,
                                    id_cuaderno: mov.id_cuaderno,
                                    cuaderno_nombre: mov.cuaderno_nombre,
                                    pdf_azul: pdfAzul,
                                    pdf_rojo: pdfRojo,
                                    tiene_pdf_azul: !!(pdfAzul && (pdfAzul.base64 || pdfAzul.nombre)),
                                    tiene_pdf_rojo: !!(pdfRojo && (pdfRojo.base64 || pdfRojo.nombre))
                                };
                            });

                            // Extraer eBook (pdf_ebook)
                            const ebook = data.ebook || data.pdf_ebook || null;
                            const ebookData = ebook ? {
                                nombre: ebook.nombre || `${data.rit}_ebook.pdf`,
                                base64: ebook.base64 || ebook.base64_content || null,
                                tipo: ebook.tipo || 'application/pdf',
                                tama√±o_kb: ebook.tama√±o_kb || (ebook.base64 ? Math.round(ebook.base64.length / 1024) : null)
                            } : null;

                            const causa = {
                                rit: data.rit || data.cabecera?.rit || rit,
                                caratulado: data.cabecera?.caratulado || data.caratulado || '-',
                                tribunal: data.cabecera?.juzgado || data.tribunal || '-',
                                fechaIngreso: data.cabecera?.fecha_ingreso || data.fecha_ingreso || '-',
                                estado: data.estado_actual?.estado || data.estado || 'EN_TRAMITE',
                                movimientos: movs,
                                totalPdfs: movs.filter(m => m.tiene_pdf_azul || m.tiene_pdf_rojo).length,
                                tieneEbook: !!ebookData,
                                ebook: ebookData,
                                cuadernos: data.cuadernos || null
                            };
                            
                            console.log(`‚úÖ ${rit} cargada:`, {
                                movimientos: movs.length,
                                pdfs: causa.totalPdfs,
                                ebook: causa.tieneEbook,
                                fuente: apiData.fuente || 'unknown'
                            });
                            
                            causasCargadas.push(causa);
                            cargadas++;
                        } else if (response.status === 401) {
                            console.warn(`‚ö†Ô∏è ${rit}: Requiere autenticaci√≥n`);
                        } else {
                            console.warn(`‚ö†Ô∏è ${rit}: ${response.status} - ${response.statusText}`);
                            errores++;
                        }
                    } catch (error) {
                        console.warn(`‚ùå Error cargando ${rit}:`, error.message);
                        errores++;
                    }
                }
                
                if (causasCargadas.length > 0) {
                    // Combinar con datos est√°ticos (mantener los que no se cargaron)
                    const ritsCargados = new Set(causasCargadas.map(c => c.rit));
                    const causasEstaticas = causasGuardadas.filter(c => !ritsCargados.has(c.rit));
                    
                    causasGuardadas.length = 0;
                    causasGuardadas.push(...causasCargadas, ...causasEstaticas);
                    
                    renderizarCausasGuardadas();
                    console.log(`‚úÖ Cargadas ${cargadas} causas desde JSON (${errores} errores)`);
                    mostrarNotificacion(`‚úÖ Cargadas ${cargadas} causas con datos reales y PDFs base64`, 'success');
                } else {
                    console.log('‚ö†Ô∏è No se pudieron cargar causas desde JSON, usando datos est√°ticos');
                    mostrarNotificacion('‚ö†Ô∏è Usando datos de ejemplo (no se encontraron datos reales). Ejecuta el scraping primero.', 'warning');
                }
            } catch (error) {
                console.error('Error cargando causas:', error);
                mostrarNotificacion('‚ùå Error cargando datos: ' + error.message, 'error');
            }
        }

        /**
         * Carga los datos de causas desde la API
         * En producci√≥n, reemplazar√≠a los datos est√°ticos
         */
        async function cargarCausasDesdeAPI() {
            try {
                const response = await fetch('/api/scraping/listar');
                if (response.ok) {
                    const data = await response.json();
                    // Actualizar causasGuardadas con datos de la API
                    console.log('Datos cargados desde API:', data);
                }
            } catch (error) {
                console.log('Usando datos locales (API no disponible)');
            }
        }

        // Inicializar
        $(document).ready(function() {
            // Mostrar loading inicial
            const loading = document.getElementById('loadingOverlay');
            if (loading) loading.classList.add('active');
            
            // Renderizar con datos est√°ticos primero
            renderizarCausasGuardadas();
            setupModalFiltersAndPagination();
            
            // Cargar datos reales en segundo plano
            cargarCausasDesdeJSON().finally(() => {
                if (loading) loading.classList.remove('active');
            });
        });
    </script>
</body>
</html>
